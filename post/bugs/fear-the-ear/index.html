<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Fear the EAR Vuln | MedBLG - InfoSec Enthusiast | Dev - DevOps - AI</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.1.2/css/all.css">
    
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <meta property="og:title" content="Fear the EAR Vuln" />
<meta property="og:description" content="Easy finding found in private h1 program, not that fancy but could lead to full compromise of the app in question" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://medblg.top/post/bugs/fear-the-ear/" />
<meta property="og:image" content="https://medblg.top/images/ZmVhci10aGUtZWFyCg==.jpeg" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="article:published_time" content="2022-08-15T23:15:11+01:00" />
<meta property="article:modified_time" content="2022-08-15T23:15:11+01:00" />

  </head>

  <body>
    
    <div class="progress-container">
      <div class="progress-bar" id="myBar"></div>
    </div>  
    <nav>
    <ul class="menu">
      
      <li><a href="/about">About</a></li>
      
      <li><a href="/">Posts</a></li>
      
      <li><a href="/categories">Categories</a></li>
      
      <li><a href="/tags">Tags</a></li>
      
    </ul>

    <ul class="menu" id="social-links">
    
      <li><a href="https://fb.me/simo.balghaoui"><i class="fa-brands fa-facebook fa-2xl"></i></a></li>

      <li><a href="https://github.com/medblg"><i class="fa-brands fa-github fa-2xl"></i></a></li>

      <li><a href="https://linkedin.com/in/medblg"><i class="fa-brands fa-linkedin-in fa-2xl"></i></a></li>

    </ul>
    
    </div>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Fear the EAR Vuln</span></h1>

<h2 class="date">Aug. 15, 2022</h2>
</div>


<main>
<figure>
<img class="featured_img" src="/images/ZmVhci10aGUtZWFyCg==.jpeg" width="600px" height="300px"/> </figure>
<h2 id="intro">Intro:</h2>
<p>It has been a while since my last blog post, and here we go again. This one will cover a vulnerability I discovered and reported back in April to a private program in HackerOne which I cannot disclose the name, but it is a well known insurance company in the USA.</p>
<p>In short I have not set and prepare for this finding as I am so busy recently with my full time job, nevertheless I spend some of my spare time on my hobby, including research.</p>
<h2 id="recon-phase">Recon phase</h2>
<p>As understood above, no time for manual inspection and recon, one online tool I have used before was to subscibe that program domain to Facebook CT (Certificate Transparency), so whenever any new subdomain or new relevant SSL certificate for the app is issued we got Facebook notification, but sometimes this is so noisy and annoying, as you&rsquo;ll turn your fb full of notifications in a short of time which I sometimes cannot deal with.</p>
<blockquote>
<p>Certificate Transparencyis an open framework which helps log, audit and monitor publicly-trusted TLS certificates on the Internet. This tool lets you search for certificates issued for a given domain and subscribe to notifications from Facebook regarding new certificates and potential phishing attacks.</p>
</blockquote>
<p>That day, I opened my phone, then my fb notifications, and noticed one potential term <code>producer</code> as part of the subdomain, the subdomain wasn&rsquo;t new at all but it was the first time I gave it attention as I rarely hack on private programs :(, as by that time I was tinkering on some of the pub/sub strategies for distributing messages, think of Redis, NSQ&hellip; I was going on a whole rabbit hole on the distributed systems things but essentially learned a lot. Anyway, the <code>publisher</code> host is sometimes also called <code>producer</code>, and the <code>subscriber</code> is called <code>consumer</code>. This whole definition by itself was enough to bring that host into my attention, let&rsquo;s call it: <strong>producer-something.redacted.com</strong></p>
<h2 id="manual-inspection-and-exploitation">Manual inspection and exploitation</h2>
<p>I opened the host on my phone browser, and it redirects me to another subdomain which is the company&rsquo;s Oauth endpoint, this makes sense since the subdomain seems to host something sensitive.</p>
<p>This time I tried to open the subdomain on my laptop&rsquo;s browser, and I&rsquo;ve noticed the same behavior, the 1st thing I did after was to simply open it in source code view, say: <em>view-source:host</em> while preventing any redirect.</p>
<p>the source code contains a javascript function that was something similar to this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#ff79c6">&lt;</span>script<span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">if</span>( <span style="color:#8be9fd;font-style:italic">window</span>.location.href.indexOf(<span style="color:#f1fa8c">&#34;#access_token&#34;</span>)<span style="color:#ff79c6">&gt;-</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">||</span> <span style="color:#8be9fd;font-style:italic">window</span>.location.href.indexOf(<span style="color:#f1fa8c">&#34;#code&#34;</span>)<span style="color:#ff79c6">&gt;-</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">||</span> <span style="color:#8be9fd;font-style:italic">window</span>.location.href.indexOf(<span style="color:#f1fa8c">&#34;#id_token&#34;</span>)<span style="color:#ff79c6">&gt;-</span><span style="color:#bd93f9">1</span> ) {	
</span></span><span style="display:flex;"><span>				<span style="color:#8be9fd;font-style:italic">window</span>.location.replace( $actual_link );
</span></span><span style="display:flex;"><span>			} <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#8be9fd;font-style:italic">var</span> url <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;https://producer-something.redacted.com&#34;</span>;
</span></span><span style="display:flex;"><span>				url <span style="color:#ff79c6">=</span> url <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/?option=oauthredirect&amp;app_name=&#39;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;auth0&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;&amp;redirect_url=&#39;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;https%3A%2F%2Fproducer-something.redacted.com%2Fother-sensitive-content&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;&amp;restrictredirect=true&#39;</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#8be9fd;font-style:italic">window</span>.location.replace( url );
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;</span>/script&gt;
</span></span></code></pre></div><ul>
<li>As can be understood from the above code, there was a validation step before redirecting to the Oauth endpoint.</li>
<li>The condition was only checking if the href attributes contains literally one of the three <code>#access_token</code>, <code>#code</code> and <code>#id_token</code>.</li>
</ul>
<p>To test if we can bypass this client-side validation, I simply validated the condition by requesting: <strong><a href="https://producer-something.redacted.com/%7Bone-of-the-three-validation-words-above%7D">https://producer-something.redacted.com/{one-of-the-three-validation-words-above}</a></strong>, this was indeed enough as a bypass, and the content of the host was shown without any issues containing the sensitive data as simple as it sounds.</p>
<p>It was also possible to bypass the validation by simply deactivating the Javascript through the DevTool, or by using a plugin called <strong>quick javascript switcher</strong></p>
<figure>
    <img class="featured_img" src="/images/disable-js-devtool.png" width="400px" height="350px"/> 
        <figcaption style="margin-top:10px;font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;color: rgba(117, 117, 117, 1);">
        devtool
        </figcaption></figure>
<p>But this isn&rsquo;t practical as all the page contents depend on javascript, so switching off js would actually bypass the restriction but would render nothing.</p>
<p>And later on I found that any resource can be unlocked using the above keywords, like for instance, requesting <strong>wp-login.php</strong> would redirect to the Oauth first, but appending one of the three keywords wouldn&rsquo;t, <strong>wp-login.php#code</strong> for instance.</p>
<h2 id="bug-history-and-a-disclosed-report-use-case">Bug history and a disclosed report use-case</h2>
<p>This is a well known vulnerability, and could be found in the wild, say for example a restricted areas where a huge content size was issued instead of few lines rendering a default 404 page, so always stop by and do some manual code source. This is not always JS related, other languages are vulnerable as well.</p>
<p>A good resource for this is the <a href="https://owasp.org/www-community/attacks/Execution_After_Redirect_(EAR)">OWASP-EAR</a> and mainly the research <a href="http://cs.ucsb.edu/~bboe/public/pubs/fear-the-ear-ccs2011.pdf">Fear the EAR</a>.</p>
<p>There is a great disclosed report by my friend El Mahdi on this (<a href="https://hackerone.com/reports/683957">https://hackerone.com/reports/683957</a>) and was awarded $4k, as a full post-exploitation impact was assessed, and the root underlying cause was a simple yet powerfull EAR bug, shoutout to Mahdi for the disclosure.</p>
<h2 id="lesson-learned-and-notes">Lesson learned and notes</h2>
<ul>
<li>Passively monitor assets for new CT is a good habit.</li>
<li>Read source code.</li>
<li>Observe application changes.</li>
<li>Take action, and participate on Private programs :).</li>
</ul>
<h2 id="responsible-disclosure-timeline">Responsible disclosure timeline</h2>
<ul>
<li>Bug sumbitted through HackerOne: Apr 25th.</li>
<li>Triaged by the program internal team: Apr 25th (same day, :).</li>
<li>Bounty rewarded three days later: Apr 28th.</li>
</ul>

	
<a class="tag" href="/tags/php_sec">#php_sec</a>
	
<a class="tag" href="/tags/ear-bug">#ear-bug</a>

</main>
<aside>
<div class="latest-posts">
    <h3 style="text-align: center;">
        Category: 
        
        <a class="cat" href="/categories/bugs">
            bugs
        </a>
        
    </h3>
    <ul>
        
            
            
       <table>
            
            
            
        <tr>
            <th><li style="list-style: none;"><span>Previous</span>: </th><td><a href="https://medblg.top/post/bugs/strongkey-rce/">Struts your way into Strongkey [RCE]</a></li></td>
            
        </tr>
            
            
            
        </table>

    </ul>
</div>
</aside>
<script>
	window.addEventListener('DOMContentLoaded', () => {
		const observerForTableOfContentActiveState = new IntersectionObserver(entries => {
			entries.forEach(entry => {
				const id = entry.target.getAttribute('id');

				if (entry.intersectionRatio > 0) {					
					clearActiveStatesInTableOfContents();				
					document.querySelector(`nav li a[href="#${id}"]`).parentElement.classList.add('active');
				}
			});
		});		
		document.querySelectorAll('h1[id],h2[id],h3[id],h4[id]').forEach((section) => {
			observerForTableOfContentActiveState.observe(section);
		});

	});

	function clearActiveStatesInTableOfContents() {
		document.querySelectorAll('nav li').forEach((section) => {
			section.classList.remove('active');
		});
	}
</script>

  <footer>
  
  
  </footer>
  <script>
    
    window.onscroll = function() {myFunction()};

    function myFunction() {
      var winScroll = document.body.scrollTop || document.documentElement.scrollTop;
      var height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      var scrolled = (winScroll / height) * 100;
      document.getElementById("myBar").style.width = scrolled + "%";
    }
</script>
  </body>
</html>

